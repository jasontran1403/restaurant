<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="assets/images/favicon/favicon.png" rel="icon">
  <title>Admin</title>
  <!-- plugins:css -->
    <link rel="stylesheet" th:href="@{/assets/admin/vendors/feather/feather.css}">
  <link rel="stylesheet" th:href="@{/assets/admin/vendors/ti-icons/css/themify-icons.css}">
  <link rel="stylesheet" th:href="@{/assets/admin/vendors/css/vendor.bundle.base.css}">
  <!-- endinject -->
  <!-- Plugin css for this page -->
  <link rel="stylesheet" th:href="@{/assets/admin/vendors/datatables.net-bs4/dataTables.bootstrap4.css}">
  <link rel="stylesheet" th:href="@{/assets/admin/vendors/ti-icons/css/themify-icons.css}">
  <link rel="stylesheet" type="text/css" th:href="@{/assets/admin/js/select.dataTables.min.css}">
  <!-- End plugin css for this page -->
  <!-- inject:css -->
  <link rel="stylesheet" th:href="@{/assets/admin/css/vertical-layout-light/style.css}">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>
  <!-- endinject -->
  <link rel="shortcut icon" th:href="@{/assets/images/logo/logo-xl.png}" />
  <link rel="stylesheet" th:href="@{/assets/admin/css/toastStyle.css}" />
  <style>
    /* Toast Success Custom */
    .toast-success-custom {
      background-color: #28a745;  /* Màu xanh lá */
      color: white;
    }

    /* Toast Error Custom */
    .toast-error-custom {
      background-color: #dc3545;  /* Màu đỏ */
      color: white;
    }
  </style>

</head>

<body>
  <div class="container-scroller">
  <div id="toast" class="hidden">
      <div id="toast-list" class="toast-list"></div>
    </div>
    <!-- partial:../../partials/_navbar.html -->
    <nav class="navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
      <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-center">
        <a class="navbar-brand brand-logo mr-5" href="/admin/dashboard"><img th:src="@{/assets/images/logo/logo-dark.png}" class="mr-2" alt="logo"/></a>
        <a class="navbar-brand brand-logo-mini" href="/admin/dashboard"><img th:src="@{/assets/images/logo/logo-dark.png}" alt="logo"/></a>
      </div>
      <div class="navbar-menu-wrapper d-flex align-items-center justify-content-end">
        <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
          <span class="icon-menu"></span>
        </button>
        <ul class="navbar-nav navbar-nav-right">
          <li class="nav-item dropdown">
            <a class="nav-link count-indicator dropdown-toggle" id="notificationDropdown" href="#" data-toggle="dropdown">
              <i class="icon-bell mx-0"></i>
              <span class="count"></span>
            </a>
            <div class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list" aria-labelledby="notificationDropdown">
              <p class="mb-0 font-weight-normal float-left dropdown-header">Notifications</p>
              <a class="dropdown-item preview-item">
                <div class="preview-thumbnail">
                  <div class="preview-icon bg-success">
                    <i class="ti-info-alt mx-0"></i>
                  </div>
                </div>
                <div class="preview-item-content">
                  <h6 class="preview-subject font-weight-normal">Application Error</h6>
                  <p class="font-weight-light small-text mb-0 text-muted">
                    Just now
                  </p>
                </div>
              </a>
              <a class="dropdown-item preview-item">
                <div class="preview-thumbnail">
                  <div class="preview-icon bg-warning">
                    <i class="ti-settings mx-0"></i>
                  </div>
                </div>
                <div class="preview-item-content">
                  <h6 class="preview-subject font-weight-normal">Settings</h6>
                  <p class="font-weight-light small-text mb-0 text-muted">
                    Private message
                  </p>
                </div>
              </a>
              <a class="dropdown-item preview-item">
                <div class="preview-thumbnail">
                  <div class="preview-icon bg-info">
                    <i class="ti-user mx-0"></i>
                  </div>
                </div>
                <div class="preview-item-content">
                  <h6 class="preview-subject font-weight-normal">New user registration</h6>
                  <p class="font-weight-light small-text mb-0 text-muted">
                    2 days ago
                  </p>
                </div>
              </a>
            </div>
          </li>
          <li class="nav-item nav-profile dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" id="profileDropdown">
              <img th:src="@{/assets/admin/images/faces/face28.jpg}" alt="profile"/>
            </a>
            <div class="dropdown-menu dropdown-menu-right navbar-dropdown" aria-labelledby="profileDropdown">
              <a class="dropdown-item">
                <i class="ti-settings text-primary"></i>
                Settings
              </a>
              <a class="dropdown-item">
                <i class="ti-power-off text-primary"></i>
                Logout
              </a>
            </div>
          </li>
        </ul>
        <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-toggle="offcanvas">
          <span class="icon-menu"></span>
        </button>
      </div>
    </nav>
    
    
    <!-- partial -->
    <div class="container-fluid page-body-wrapper">
      <!-- partial:../../partials/_settings-panel.html -->
      
      <!-- partial -->
      <!-- partial:../../partials/_sidebar.html -->
      <nav class="sidebar sidebar-offcanvas" id="sidebar">
        <ul class="nav">
          <li class="nav-item">
            <a class="nav-link" href="/admin/dashboard">
              <i class="icon-grid menu-icon"></i>
              <span class="menu-title">Tổng quan</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/orders">
              <i class="icon-grid menu-icon"></i>
              <span class="menu-title">Quản lý đơn đặt hàng</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/foods">
              <i class="icon-grid menu-icon"></i>
              <span class="menu-title">Quản lý món ăn</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/cates">
              <i class="icon-grid menu-icon"></i>
              <span class="menu-title">Quản lý danh mục</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/coupons">
              <i class="icon-grid menu-icon"></i>
              <span class="menu-title">Quản lý mã giảm</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/users">
              <i class="icon-grid menu-icon"></i>
              <span class="menu-title">Quản lý agency</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/commissions">
              <i class="icon-grid menu-icon"></i>
              <span class="menu-title">Danh sách commission</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/stocks">
              <i class="icon-grid menu-icon"></i>
              <span class="menu-title">Quản lý kho</span>
            </a>
          </li>
        </ul>
      </nav>
      
      
      <!-- partial -->
      <div class="main-panel">        
        <div class="content-wrapper">
          <div class="row">
            <div class="row">
              <!-- Dòng 1: Nút Cập nhật kho -->
              <div class="col-12 col-lg-4 mb-3">
                <button type="button" class="btn btn-primary w-100" data-toggle="modal" data-target="#exampleModalCenter">
                  Cập nhật kho
                </button>
              </div>

              <!-- Dòng 2: Input chọn ngày -->
              <div class="col-6 col-lg-4 mb-3">
                <input type="date" id="fromDate" placeholder="Từ ngày" class="form-control" required>
              </div>
              <div class="col-6 col-lg-4 mb-3">
                <input type="date" id="toDate" placeholder="Đến ngày" class="form-control" required>
              </div>

              <!-- Dòng 3: Nút Xuất báo cáo -->
              <div class="col-12 col-lg-4 mb-3">
                <button type="button" class="btn btn-primary w-100" onclick="exportReport()">
                  Xuất báo cáo
                </button>
              </div>
            </div>
            <script>
              document.addEventListener("DOMContentLoaded", function () {
                const fromDateInput = document.getElementById("fromDate");
                const toDateInput = document.getElementById("toDate");

                // Set the minimum date to today for both inputs
                const today = new Date().toISOString().split("T")[0];
                // fromDateInput.setAttribute("min", today);
                toDateInput.setAttribute("min", today);
                toDateInput.disabled = true; // Initially disable toDate

                // Update the `min` attribute of `toDate` based on `fromDate` selection
                fromDateInput.addEventListener("change", function () {
                  const selectedFromDate = fromDateInput.value;

                  if (selectedFromDate) {
                    toDateInput.disabled = false; // Enable toDate when fromDate is selected

                    // Calculate the next day and set it as the minimum date for toDate
                    const nextDay = new Date(selectedFromDate);
                    nextDay.setDate(nextDay.getDate() + 1);
                    const nextDayString = nextDay.toISOString().split("T")[0];
                    toDateInput.setAttribute("min", nextDayString);

                    // If toDate is earlier than fromDate + 1 day, reset its value
                    if (toDateInput.value && toDateInput.value < nextDayString) {
                      toDateInput.value = "";
                    }
                  } else {
                    toDateInput.disabled = true; // Disable toDate if fromDate is not selected
                    toDateInput.value = ""; // Reset toDate value
                  }
                });
              });
            </script>

            <script>
              function exportReport() {
                // Get the date input values
                const fromDateInput = document.getElementById('fromDate').value;
                const toDateInput = document.getElementById('toDate').value;

                // Validate if dates are selected
                if (!fromDateInput || !toDateInput) {
                  alert("Please select both From Date and To Date.");
                  return;
                }

                // Convert date strings to Unix timestamps (milliseconds)
                const fromDate = new Date(fromDateInput).getTime();
                const toDate = new Date(toDateInput).getTime();

                // Check if fromDate is earlier than toDate
                if (fromDate > toDate) {
                  alert("From Date must be earlier than To Date.");
                  return;
                }

                // Define the API endpoint
                const apiUrl = `/admin/export`;

                // Create a full URL with query parameters
                const url = `${apiUrl}?startDate=${fromDate}&endDate=${toDate}`;

                // Create an invisible link element
                const link = document.createElement('a');
                link.href = url;

                // Set the download attribute for the browser to treat it as a file download
                link.setAttribute('download', 'stocks_report.xlsx');

                // Trigger the click event
                document.body.appendChild(link);
                link.click();

                // Clean up
                document.body.removeChild(link);
              }
            </script>
            <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h4 class="card-title">Cập nhật kho</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <form class="forms-sample" th:action="@{/admin/add-stocks}" enctype="multipart/form-data" method="POST" th:object="${stockRequest}">
                      <div class="form-group">
                        <label for="exampleSelectProduct">Sản phẩm</label>
                        <select class="form-control" id="exampleSelectProduct" th:field="*{id}" required onchange="updatePrice()">
                          <option value="-1" disabled selected>Chọn sản phẩm</option>
                          <option th:each="food : ${listFood}" th:value="${food.id}" th:text="${food.name}" th:data-price="${food.getDefaultPrice()}"></option>
                        </select>
                        <script>
                          // Hàm update giá
                          function updatePrice() {
                            // Lấy giá từ thuộc tính data-price của option được chọn
                            var selectedOption = document.getElementById('exampleSelectProduct').selectedOptions[0];
                            var price = selectedOption.getAttribute('data-price');

                            // Cập nhật giá vào ô nhập liệu
                            document.getElementById('exampleInputName3').value = price;
                          }

                          // Gọi hàm updatePrice khi trang được load
                          window.onload = function() {
                            updatePrice();  // Gọi hàm updatePrice ngay khi trang load
                          }
                        </script>
                      </div>
                      <div class="form-group">
                        <label for="exampleInputName2">Số lượng </label>
                        <input type="number" class="form-control" id="exampleInputName2" placeholder="Số lượng " th:field="*{quantity}" required/>
                      </div>
                      <div class="form-group">
                        <label for="exampleInputName3">Đơn giá nhập </label>
                        <input type="number" class="form-control" min="0" id="exampleInputName3" placeholder="Đơn giá nhập " th:field="*{price}" required/>
                      </div>
                      <div class="form-group">
                        <label for="exampleSelectProduct2">Loại</label>
                        <select class="form-control" id="exampleSelectProduct2" th:field="*{type}" required onchange="checkLoai()">
                          <option value="" disabled selected>Chọn loại</option>
                          <option th:each="typeItem : ${listType}" th:value="${typeItem}" th:text="${typeItem}">
                          </option>
                        </select>
                      </div>
                      <button type="submit" class="btn btn-primary mr-2">Cập nhật </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <div class="modal fade" id="example2ModalCenter" tabindex="-1" role="dialog" aria-labelledby="example2ModalCenterTitle" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h4 class="card-title">Điều chỉnh</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <form class="forms-sample" th:action="@{/admin/edit-stocks}" enctype="multipart/form-data" method="POST" th:object="${editStock}">
                      <div class="form-group">
                        <label for="exampleSelectProduct5">Stock History ID</label>
                        <input type="number" class="form-control" min="1" id="exampleSelectProduct5" placeholder="ID " th:field="*{newId}" required readonly />
                      </div>
                      <div class="form-group">
                        <label for="exampleInputName2">Số lượng </label>
                        <input type="number" class="form-control" min="1" id="exampleInputName4" placeholder="Số lượng " th:field="*{newQuantity}" required />
                      </div>
                      <div class="form-group">
                        <label for="exampleInputName3">Đơn giá </label>
                        <input type="number" class="form-control" min="1" id="exampleInputName5" placeholder="Đơn giá nhập " th:field="*{newPrice}" required readonly/>
                      </div>
                      <div class="form-group">
                        <label for="exampleSelectProduct2">Loại</label>
                        <select class="form-control" id="exampleSelectProduct6" th:field="*{newType}" required disabled>
                          <option value="" disabled selected>Chọn loại</option>
                          <option th:each="typeItem : ${listType}"
                                  th:value="${typeItem}"
                                  th:text="${typeItem}">
                          </option>
                        </select>
                      </div>
                      <button type="submit" class="btn btn-primary mr-2">Lưu </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>

          	<div class="col-lg-12 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <h4 class="card-title">Danh sách nhập kho </h4>
                  <div class="form-group">
		                <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm bằng tên sản phẩm...">
		            </div>
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>Thời gian</th>
                          <th>Tên sản phẩm</th>
                          <th>Đơn giá</th>
                          <th>Số lượng</th>
                          <th>Phân loại</th>
                          <th>Chức năng</th>
                        </tr>
                      </thead>
                      <tbody>
                      <tr th:each="stockItem : ${stocksPage.content}">
                        <td>
                          <p th:text="${@dateUtils.formatTimestamp(stockItem.date)}"></p>
                        </td>
                        <td>
                          <p><span th:text="${stockItem.name}"></span></p>
                        </td>
                        <td>
                          <p th:text="${stockItem.price}"1
                             th:classappend="${stockItem.type == 'In' ? '' : 'disabled-price'}">
                          </p>
                        </td>
                        <td>
                          <p th:text="${stockItem.quantity}"></p>
                        </td>
                        <td>
                          <p th:text="${stockItem.type}"
                             th:classappend="${stockItem.type == 'In' ? 'text-green' : (stockItem.type == 'Out' ? 'text-red' : 'text-yellow')}">
                          </p>
                          <p style="font-style: italic" th:if="${not #strings.isEmpty(stockItem.note)}" th:text="${stockItem.note}"></p>                        </td>
                        <td>
                          <button
                                  th:data-id="${stockItem.id}"
                                  th:data-quantity="${stockItem.quantity}"
                                  th:data-price="${stockItem.price}"
                                  th:data-type="${stockItem.type}"
                                  type="button" class="btn btn-primary" data-toggle="modal" data-target="#example2ModalCenter">
                            Điều chỉnh
                          </button>

                          <button
                                  th:data-foodname="${stockItem.name}"
                                  type="button" class="btn btn-primary" data-toggle="modal" data-target="#example3ModalCenter">
                            Kiểm tra
                          </button>

                        </td>
                      </tr>
                      </tbody>
                    </table>
                    <div class="modal fade" id="example3ModalCenter" tabindex="-1" role="dialog" aria-labelledby="example2ModalCenterTitle" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h4 class="card-title">Kiểm tra kho</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                            </button>
                          </div>
                          <div class="modal-body">
                            <form class="forms-sample" th:action="@{/admin/check-stocks}" enctype="multipart/form-data" method="POST">
                              <div class="form-group">
                                <label for="foodName">Tên sản phẩm</label>
                                <input type="text" class="form-control" id="foodName" name="foodName" readonly />
                              </div>
                              <div class="form-group">
                                <label for="realQuantity">Số lượng thực tế</label>
                                <input type="number" class="form-control" min="1" id="realQuantity" name="realQuantity" placeholder="Số lượng thực tế" required />
                              </div>
                              <button type="submit" class="btn btn-primary mr-2">Kiểm tra</button>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Script xử lý modal -->

                    <div th:if="${stocksPage.totalPages > 1}" style="display: flex; justify-content: space-around">
					    <ul class="pagination">
					        <li th:class="${stocksPage.first ? 'page-item disabled' : 'page-item'}">
					            <a th:href="@{/admin/stocks(page=${stocksPage.number - 1})}" class="page-link">Previous</a>
					        </li>
					        <li th:class="${stocksPage.last ? 'page-item disabled' : 'page-item'}">
					            <a th:href="@{/admin/stocks(page=${stocksPage.number + 1})}" class="page-link">Next</a>
					        </li>
					    </ul>
					</div>

                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- main-panel ends -->
    </div>
    <!-- page-body-wrapper ends -->
  </div>
  <!-- container-scroller -->
  <!-- plugins:js -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <script th:src="@{/assets/admin/vendors/js/vendor.bundle.base.js}"></script>
  <!-- endinject -->
  <!-- Plugin js for this page -->
  <script th:src="@{/assets/admin/vendors/chart.js/Chart.min.js}"></script>
  <script th:src="@{/assets/admin/vendors/datatables.net/jquery.dataTables.js}"></script>
  <script th:src="@{/assets/admin/vendors/datatables.net-bs4/dataTables.bootstrap4.js}"></script>
  <script th:src="@{/assets/admin/js/dataTables.select.min.js}"></script>

  <!-- End plugin js for this page -->
  <!-- inject:js -->
<script>
    $(document).ready(function() {
        $('#searchInput').on('keyup', function() {
            var searchText = $(this).val().toLowerCase();
            $('table tbody tr').each(function() {
                var foodName = $(this).find('td:nth-child(6)').text().toLowerCase() || $(this).find('td:nth-child(7)').text().toLowerCase();
                if (foodName.indexOf(searchText) === -1) {
                    $(this).hide();
                } else {
                    $(this).show();
                }
            });
        });
    });
</script>
  <script th:src="@{/assets/admin/js/off-canvas.js}"></script>
  <script th:src="@{/assets/admin/js/hoverable-collapse.js}"></script>
  <script th:src="@{/assets/admin/js/template.js}"></script>
  <script th:src="@{/assets/admin/js/settings.js}"></script>
  <script th:src="@{/assets/admin/js/todolist.js}"></script>
  <!-- endinject -->
  <!-- Custom js for this page-->
  <script th:src="@{/assets/admin/js/dashboard.js}"></script>
  <script th:src="@{/assets/admin/js/Chart.roundedBarCharts.js}"></script>
  <script th:src="@{/assets/admin/js/script-admin-side.js}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <!-- End custom js for this page-->
  <script>
    $('#example2ModalCenter').on('show.bs.modal', function (event) {
      // Lấy button đã kích hoạt modal
      var button = $(event.relatedTarget);
      // Lấy id từ thuộc tính data-id
      var stockId = button.data('id');
      var stockQuantity = button.data('quantity');
      var stockPrice = button.data('price');
      var stockType = button.data('type');

      // Gán id vào input
      var modal = $(this);
      modal.find('#exampleSelectProduct5').val(stockId);
      modal.find('#exampleInputName4').val(stockQuantity);
      modal.find('#exampleInputName5').val(stockPrice);
      modal.find("#exampleSelectProduct6").val(stockType).change();
    });
  </script>

  <script>
    $('#example3ModalCenter').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget);
      console.log(button);
      var foodName = button.data('foodname');

      console.log(foodName);
      var modal = $(this);
      modal.find('#foodName').val(foodName);
      modal.find('#realQuantity').val(''); // Reset giá trị số lượng
    });
  </script>

  <script th:inline="javascript">
    /*<![CDATA[*/
    var msg = /*[[${msg}]]*/ '';  // Lấy thông báo từ controller
    if (msg) {
      // Kiểm tra xem thông báo có chứa từ khóa thành công hay thất bại
      if (msg.indexOf("thành công") !== -1) {
        toastr.success(msg, "Thành công", {
          "timeOut": "3000", // Thời gian hiển thị 3 giây
          "closeButton": true,
          "progressBar": true,
          "toastClass": "toast-success-custom"  // Thêm lớp tùy chỉnh cho success
        });
      } else if (msg.indexOf("thất bại") !== -1) {
        toastr.error(msg, "Lỗi", {
          "timeOut": "3000", // Thời gian hiển thị 3 giây
          "closeButton": true,
          "progressBar": true,
          "toastClass": "toast-error-custom"  // Thêm lớp tùy chỉnh cho error
        });
      }
    }
    /*]]>*/
  </script>

</body>

</html>
